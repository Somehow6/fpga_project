# ç›¸ä½æ£€æµ‹æµ‹è¯•åˆ†æ”¯ - ä¿®æ”¹è¯´æ˜

**æ—¥æœŸ**: 2025/11/08  
**ç›®çš„**: ç®€åŒ–æµ‹è¯•ï¼Œä¸“æ³¨äºç›¸ä½æ£€æµ‹åŠŸèƒ½è°ƒè¯•

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å¼ºåˆ¶bit_sequenceä¸ºå¸¸1

**æ–‡ä»¶**: `rtl/hs_dual_da.v`

**ä¿®æ”¹å†…å®¹**:
```verilog
// åŸä»£ç ï¼ˆæ³¨é‡Šæ‰ï¼‰:
// assign  bit_sequence = bit_sequence_internal;  // ASKè°ƒåˆ¶

// æ–°ä»£ç :
assign  bit_sequence = 1'b1;  // å¼ºåˆ¶å¸¸1ï¼Œè¾“å‡ºè¿ç»­æ­£å¼¦æ³¢
```

**æ•ˆæœ**:
- âœ… DAè¾“å‡ºè¿ç»­æ­£å¼¦æ³¢ï¼ˆä¸å†æœ‰ASKè°ƒåˆ¶çš„0/1åˆ‡æ¢ï¼‰
- âœ… `bit_seq_60m_sync2`åœ¨60MHzåŸŸå§‹ç»ˆä¸º1
- âœ… ç›¸ä½æ£€æµ‹å™¨çš„`bit_valid_sync`å§‹ç»ˆä¸º1
- âœ… é›¶äº¤å‰æ£€æµ‹æŒç»­å·¥ä½œ

---

## ğŸ” ç›¸ä½å·®åªåœ¨0-2å¾˜å¾Šçš„é—®é¢˜åˆ†æ

### å¯èƒ½åŸå› 1ï¼šç›¸ä½ç´¯åŠ å™¨å€¼å¼‚å¸¸å°

**æ£€æŸ¥ç‚¹**:
- `phase_acc_20m`çš„å®é™…å€¼æ˜¯å¤šå°‘ï¼Ÿ
- `addr_step_reg`æ˜¯å¦æ­£ç¡®ï¼Ÿï¼ˆé»˜è®¤705ï¼‰

**éªŒè¯æ–¹æ³•**:
```verilog
// åœ¨20MHzæ—¶é’Ÿä¸‹ï¼Œphase_accåº”è¯¥å¿«é€Ÿå¢é•¿
// é¢‘ç‡215kHzï¼Œå‘¨æœŸ4.65us
// åœ¨20MHzä¸‹ï¼Œ4.65us = 93ä¸ªæ—¶é’Ÿå‘¨æœŸ
// æ¯ä¸ªå‘¨æœŸphase_accå¢åŠ 705
// ä¸€ä¸ªæ­£å¼¦æ³¢å‘¨æœŸï¼š65536 / 705 â‰ˆ 93ä¸ªæ—¶é’Ÿå‘¨æœŸ âœ“
```

**é¢„æœŸ**:
- `phase_acc_20m`åº”è¯¥åœ¨0-65535ä¹‹é—´å¾ªç¯
- é¢‘ç‡215kHzä¸‹ï¼Œæ¯4.65uså¾ªç¯ä¸€æ¬¡

### å¯èƒ½åŸå› 2ï¼šCDCåŒæ­¥å»¶è¿Ÿå¯¼è‡´phase_accé‡‡æ ·åˆ°å°å€¼

**é—®é¢˜æè¿°**:
- `phase_acc_20m`æ¯ä¸ª20MHzå‘¨æœŸå¢åŠ 705
- CDCåŒæ­¥æœ‰2çº§å»¶è¿Ÿï¼ˆ~100nsï¼‰
- å¦‚æœé›¶äº¤å‰æ°å¥½å‘ç”Ÿåœ¨phase_accä»65535æº¢å‡ºåˆ°0çš„ç¬é—´ï¼Œå¯èƒ½é‡‡æ ·åˆ°0-2çš„å°å€¼

**è§£å†³æ–¹æ¡ˆ**: ä¸éœ€è¦ä¿®æ”¹ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚åº”è¯¥è§‚å¯Ÿæ›´å¤šé‡‡æ ·ç‚¹ã€‚

### å¯èƒ½åŸå› 3ï¼šé›¶äº¤å‰æ£€æµ‹æ¡ä»¶è¿‡ä¸¥

**å½“å‰ä»£ç **:
```verilog
assign zero_crossing = (adc_prev < ADC_MIDPOINT) && (adc_curr >= ADC_MIDPOINT) 
                       && adc_data_valid && bit_valid_sync;
```

**é—®é¢˜**:
- ADC_MIDPOINT = 2048ï¼ˆ0Vå‚è€ƒç‚¹ï¼‰
- å¦‚æœADCä¿¡å·åç½®ä¸æ˜¯2048ï¼Œå¯èƒ½æ£€æµ‹ä¸åˆ°é›¶äº¤å‰
- å¦‚æœADCå™ªå£°å¤§ï¼Œå¯èƒ½é¢‘ç¹è§¦å‘é›¶äº¤å‰

**å»ºè®®è°ƒè¯•**:
1. æ£€æŸ¥ADCå®é™…é‡‡é›†çš„æ•°æ®èŒƒå›´ï¼ˆæ˜¯å¦åœ¨2048é™„è¿‘æ‘†åŠ¨ï¼‰
2. æ·»åŠ é›¶äº¤å‰æ£€æµ‹çš„æ»å›ï¼ˆé˜²æ­¢å™ªå£°è§¦å‘ï¼‰

### å¯èƒ½åŸå› 4ï¼šç›¸ä½è®¡ç®—å…¬å¼ç²¾åº¦é—®é¢˜

**å½“å‰å…¬å¼**:
```verilog
phase_diff_temp = (da_phase_sync * 16'd45) >> 13;
// ç­‰ä»·äº: (phase * 45) / 8192
// ç†è®ºå€¼: (phase * 360) / 65536 = (phase * 45) / 8192 âœ“
```

**éªŒè¯**:
```
phase_acc = 0      â†’ phase_diff = 0Â°     âœ“
phase_acc = 16384  â†’ phase_diff = 90Â°    (16384*45/8192 = 90)
phase_acc = 32768  â†’ phase_diff = 180Â°   (32768*45/8192 = 180)
phase_acc = 49152  â†’ phase_diff = 270Â°   (49152*45/8192 = 270)
phase_acc = 65535  â†’ phase_diff = 360Â°   (65535*45/8192 â‰ˆ 360)
```

**ç»“è®º**: å…¬å¼æ­£ç¡®ï¼Œç²¾åº¦è¶³å¤Ÿã€‚

---

## ğŸ› æœ€å¯èƒ½çš„é—®é¢˜ï¼šADCä¿¡å·åç½®

### é—®é¢˜æè¿°

å¦‚æœADCé‡‡é›†çš„ä¿¡å·ä¸æ˜¯ä»¥2048ä¸ºä¸­å¿ƒæ‘†åŠ¨ï¼Œé›¶äº¤å‰æ£€æµ‹ä¼šå¤±æ•ˆã€‚

**æƒ…å†µ1**: ADCä¿¡å·å…¨éƒ¨<2048ï¼ˆè´Ÿåç½®ï¼‰
```
adc_prev = 1500, adc_curr = 1600
â†’ éƒ½ < 2048ï¼Œæ°¸è¿œä¸ä¼šè§¦å‘é›¶äº¤å‰
â†’ phase_diffæ°¸è¿œä¸æ›´æ–°ï¼Œä¿æŒåˆå§‹å€¼0
```

**æƒ…å†µ2**: ADCä¿¡å·å…¨éƒ¨>2048ï¼ˆæ­£åç½®ï¼‰
```
adc_prev = 2500, adc_curr = 2600
â†’ éƒ½ >= 2048ï¼Œæ°¸è¿œä¸ä¼šè§¦å‘é›¶äº¤å‰
```

**æƒ…å†µ3**: ADCä¿¡å·æ‘†å¹…å¤ªå°
```
adc_dataåœ¨2000-2100ä¹‹é—´æ‘†åŠ¨
â†’ å¯èƒ½å¶å°”è§¦å‘é›¶äº¤å‰ï¼Œä½†ç›¸ä½é‡‡æ ·ä¸ç¨³å®š
```

### è§£å†³æ–¹æ¡ˆï¼šåŠ¨æ€é›¶ç‚¹æ ¡å‡†

å»ºè®®åœ¨ç›¸ä½æ£€æµ‹å™¨ä¸­æ·»åŠ åŠ¨æ€é›¶ç‚¹è·Ÿè¸ªï¼š

```verilog
// åŠ¨æ€è®¡ç®—ADCä¿¡å·çš„å¹³å‡å€¼ä½œä¸ºé›¶ç‚¹
reg [15:0] adc_sum;      // ç´¯åŠ å’Œ
reg [3:0]  sample_cnt;   // é‡‡æ ·è®¡æ•°
reg [11:0] adc_midpoint_dynamic;  // åŠ¨æ€é›¶ç‚¹

always @(posedge clk_60m) begin
    if (adc_data_valid) begin
        if (sample_cnt < 15) begin
            adc_sum <= adc_sum + adc_data;
            sample_cnt <= sample_cnt + 1;
        end else begin
            // è®¡ç®—å¹³å‡å€¼ä½œä¸ºæ–°çš„é›¶ç‚¹
            adc_midpoint_dynamic <= adc_sum[15:4];  // é™¤ä»¥16
            adc_sum <= adc_data;
            sample_cnt <= 1;
        end
    end
end

// ä½¿ç”¨åŠ¨æ€é›¶ç‚¹æ£€æµ‹é›¶äº¤å‰
assign zero_crossing = (adc_prev < adc_midpoint_dynamic) && 
                       (adc_curr >= adc_midpoint_dynamic) && 
                       adc_data_valid && bit_valid_sync;
```

---

## ğŸ”§ å»ºè®®çš„è°ƒè¯•æ­¥éª¤

### Step 1: éªŒè¯DAè¾“å‡ºï¼ˆç¤ºæ³¢å™¨ï¼‰

**æ£€æŸ¥é¡¹**:
- [ ] DAè¾“å‡ºæ˜¯å¦ä¸ºè¿ç»­æ­£å¼¦æ³¢ï¼ˆä¸å†æœ‰ASKè°ƒåˆ¶ï¼‰
- [ ] é¢‘ç‡æ˜¯å¦ä¸º215kHzï¼ˆæˆ–å½“å‰addr_stepå¯¹åº”é¢‘ç‡ï¼‰
- [ ] å¹…åº¦æ˜¯å¦æ­£å¸¸ï¼ˆÂ±5Vï¼‰

### Step 2: éªŒè¯ADCé‡‡é›†ï¼ˆUSBæ•°æ®ï¼‰

**æ£€æŸ¥é¡¹**:
- [ ] ADCæ•°æ®çš„æ•°å€¼èŒƒå›´ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ï¼‰
- [ ] æ˜¯å¦ä»¥2048ä¸ºä¸­å¿ƒæ‘†åŠ¨ï¼ˆæˆ–åç½®åˆ°å…¶ä»–å€¼ï¼‰
- [ ] æ³¢å½¢æ˜¯å¦æ­£å¼¦æ³¢ï¼ˆè¿˜æ˜¯æ–¹æ³¢/å™ªå£°ï¼‰

**Pythonè„šæœ¬éªŒè¯**:
```python
import numpy as np
import matplotlib.pyplot as plt

# è¯»å–USBæ•°æ®
data = []  # ä»USBè¯»å–çš„ADCæ•°æ®

# åˆ†æ
print(f"Min: {np.min(data)}")
print(f"Max: {np.max(data)}")
print(f"Mean: {np.mean(data)}")
print(f"Std: {np.std(data)}")

# ç»˜åˆ¶æ³¢å½¢
plt.plot(data[:1000])  # å‰1000ä¸ªé‡‡æ ·ç‚¹
plt.axhline(y=2048, color='r', linestyle='--', label='Expected Midpoint')
plt.axhline(y=np.mean(data), color='g', linestyle='--', label='Actual Mean')
plt.legend()
plt.show()
```

### Step 3: æ·»åŠ ILAç›‘æ§ç›¸ä½æ£€æµ‹

**ç›‘æ§ä¿¡å·**:
```tcl
# ILAæ ¸å¿ƒä¿¡å·
create_debug_core u_ila_phase ila
set_property C_DATA_DEPTH 4096 [get_debug_cores u_ila_phase]

# æ·»åŠ æ¢é’ˆ
create_debug_port u_ila_phase probe
set_property port_width 12 [get_debug_ports u_ila_phase/probe0]
connect_debug_port u_ila_phase/probe0 [get_nets {adc_capture_data[*]}]

create_debug_port u_ila_phase probe
set_property port_width 16 [get_debug_ports u_ila_phase/probe1]
connect_debug_port u_ila_phase/probe1 [get_nets {phase_acc_60m_sync2[*]}]

create_debug_port u_ila_phase probe
set_property port_width 9 [get_debug_ports u_ila_phase/probe2]
connect_debug_port u_ila_phase/probe2 [get_nets {phase_diff[*]}]

create_debug_port u_ila_phase probe
set_property port_width 1 [get_debug_ports u_ila_phase/probe3]
connect_debug_port u_ila_phase/probe3 [get_nets {u_phase_detector/zero_crossing}]

create_debug_port u_ila_phase probe
set_property port_width 1 [get_debug_ports u_ila_phase/probe4]
connect_debug_port u_ila_phase/probe4 [get_nets {bit_seq_60m_sync2}]
```

**è§‚å¯Ÿé¡¹**:
- `adc_capture_data`ï¼šæ˜¯å¦åœ¨2048é™„è¿‘æ‘†åŠ¨ï¼Ÿ
- `phase_acc_60m_sync2`ï¼šæ˜¯å¦åœ¨0-65535å¾ªç¯ï¼Ÿ
- `zero_crossing`ï¼šæ˜¯å¦å‘¨æœŸæ€§è§¦å‘ï¼Ÿ
- `phase_diff`ï¼šæ˜¯å¦åœ¨åˆç†èŒƒå›´ï¼ˆ0-360ï¼‰ï¼Ÿ

### Step 4: å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

**å°è¯•ä»¥ä¸‹ä¿®æ”¹**:

#### ä¿®æ”¹A: æ”¾å®½é›¶äº¤å‰æ£€æµ‹æ¡ä»¶
```verilog
// æ·»åŠ æ»å›çª—å£ï¼ˆÂ±100ï¼‰
parameter HYSTERESIS = 12'd100;
assign zero_crossing = (adc_prev < (ADC_MIDPOINT - HYSTERESIS)) && 
                       (adc_curr >= (ADC_MIDPOINT + HYSTERESIS)) && 
                       adc_data_valid && bit_valid_sync;
```

#### ä¿®æ”¹B: ç›´æ¥è¯»å–phase_accè€Œä¸è®¡ç®—ç›¸ä½
```verilog
// ç®€åŒ–æµ‹è¯•ï¼šç›´æ¥è¾“å‡ºphase_accçš„é«˜8ä½
assign phase_diff = phase_acc_sync2[15:7];  // 128ä¸ªç›¸ä½åˆ†è¾¨ç‡
```

#### ä¿®æ”¹C: ä½¿ç”¨å³°å€¼æ£€æµ‹ä»£æ›¿é›¶äº¤å‰
```verilog
// æ£€æµ‹ADCä¿¡å·çš„å³°å€¼ï¼ˆæœ€å¤§å€¼ï¼‰è€Œä¸æ˜¯é›¶äº¤å‰
reg [11:0] adc_max;
wire peak_detected = (adc_prev < adc_curr) && (adc_curr > adc_max * 95 / 100);
```

---

## ğŸ“Š é¢„æœŸç»“æœï¼ˆä¿®æ”¹åï¼‰

### DAè¾“å‡º
```
                 â•±â•²      â•±â•²      â•±â•²
               â•±    â•²  â•±    â•²  â•±    â•²
bit_sequence: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  (å¸¸1)
               â•²    â•±  â•²    â•±  â•²    â•±
                 â•²â•±      â•²â•±      â•²â•±
              è¿ç»­æ­£å¼¦æ³¢ï¼ˆ215kHzï¼‰
```

### ç›¸ä½æ£€æµ‹
```
ADCä¿¡å·:      â•±â•²      â•±â•²      â•±â•²
            â•±    â•²  â•±    â•²  â•±    â•²
           â•²    â•±  â•²    â•±  â•²    â•±
zero_cross: â†‘        â†‘        â†‘    (æ¯ä¸ªå‘¨æœŸè§¦å‘ä¸€æ¬¡)

phase_diff: æ ¹æ®DAå’ŒADCçš„ç›¸ä½å·®ï¼Œåº”è¯¥åœ¨0-360åº¦ä¹‹é—´å˜åŒ–
```

**æ­£å¸¸æƒ…å†µ**:
- å¦‚æœDAå’ŒADCä¿¡å·åŒç›¸ï¼šphase_diff â‰ˆ 0Â°
- å¦‚æœADCæ»å90Â°ï¼šphase_diff â‰ˆ 90Â°
- å¦‚æœADCåç›¸ï¼ˆ180Â°ï¼‰ï¼šphase_diff â‰ˆ 180Â°

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: ä¿®æ”¹bit_sequenceä¸ºå¸¸1
2. â³ **è¿›è¡Œä¸­**: é‡æ–°ç»¼åˆå¹¶ä¸‹è½½åˆ°FPGA
3. â³ **å¾…æµ‹è¯•**: 
   - ç”¨ç¤ºæ³¢å™¨éªŒè¯DAè¾“å‡ºè¿ç»­æ­£å¼¦æ³¢
   - ç”¨USBè¯»å–ADCæ•°æ®ï¼Œåˆ†ææ•°æ®èŒƒå›´
   - è§‚å¯Ÿç›¸ä½å·®è¾“å‡ºæ˜¯å¦æ­£å¸¸

4. ğŸ”§ **å¦‚æœé—®é¢˜ä»å­˜åœ¨**: æ ¹æ®ä¸Šè¿°è°ƒè¯•æ­¥éª¤é€é¡¹æ’æŸ¥

---

## ğŸ“ å›æ»šæ–¹æ³•

å¦‚æœéœ€è¦æ¢å¤ASKè°ƒåˆ¶åŠŸèƒ½ï¼š

```verilog
// åœ¨ rtl/hs_dual_da.v ä¸­
// å–æ¶ˆæ³¨é‡ŠåŸä»£ç :
assign  bit_sequence = bit_sequence_internal;  // æ¢å¤ASKè°ƒåˆ¶

// æ³¨é‡Šæ‰æµ‹è¯•ä»£ç :
// assign  bit_sequence = 1'b1;  // æµ‹è¯•ç”¨
```

---

**æ€»ç»“**: å½“å‰ä¿®æ”¹å¼ºåˆ¶DAè¾“å‡ºè¿ç»­æ­£å¼¦æ³¢ï¼Œè¿™æ ·ç›¸ä½æ£€æµ‹å™¨å¯ä»¥æŒç»­å·¥ä½œã€‚æ¥ä¸‹æ¥éœ€è¦é€šè¿‡å®é™…æµ‹è¯•æ¥ç¡®è®¤ç›¸ä½å·®å¼‚å¸¸çš„æ ¹æœ¬åŸå› ï¼ˆæœ€å¯èƒ½æ˜¯ADCä¿¡å·åç½®é—®é¢˜ï¼‰ã€‚

