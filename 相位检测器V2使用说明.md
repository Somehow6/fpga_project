# ç›¸ä½æ£€æµ‹å™¨ V2 ä½¿ç”¨è¯´æ˜

**æ—¥æœŸ**: 2025/11/08  
**ç‰ˆæœ¬**: V2.0ï¼ˆæ”¹è¿›ç‰ˆï¼‰

---

## ğŸ“Š V1 vs V2 å¯¹æ¯”

| ç‰¹æ€§ | V1 (phase_detector.v) | V2 (phase_detector_v2.v) |
|------|----------------------|--------------------------|
| é›¶ç‚¹å‚è€ƒ | å›ºå®š2048 | **åŠ¨æ€æ ¡å‡†**ï¼ˆ64ç‚¹å¹³å‡ï¼‰|
| ADCåç½®å¤„ç† | âŒ ä¸æ”¯æŒ | âœ… è‡ªåŠ¨é€‚åº” |
| è°ƒè¯•è¾“å‡º | âŒ æ—  | âœ… ä¸°å¯Œï¼ˆmin/max/count/midpointï¼‰|
| é›¶äº¤å‰è®¡æ•° | âŒ æ—  | âœ… 16ä½è®¡æ•°å™¨ |
| åˆå§‹åŒ–æ—¶é—´ | ç«‹å³ | éœ€è¦64ä¸ªé‡‡æ ·ç‚¹ï¼ˆ~32Î¼s @ 2MHzï¼‰|
| é€‚ç”¨åœºæ™¯ | ADCä¿¡å·ç†æƒ³ï¼ˆæ— åç½®ï¼‰| **å®é™…åº”ç”¨ï¼ˆæœ‰åç½®/æ¼‚ç§»ï¼‰**|

---

## ğŸ¯ V2 æ–°å¢åŠŸèƒ½è¯¦è§£

### 1. åŠ¨æ€é›¶ç‚¹æ ¡å‡†

**åŸç†**:
```verilog
// è¿ç»­é‡‡æ ·64ä¸ªADCæ•°æ®ç‚¹ï¼Œè®¡ç®—å¹³å‡å€¼ä½œä¸ºé›¶ç‚¹
adc_midpoint = (Î£ adc_data[0:63]) / 64
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨é€‚åº”ADCä¿¡å·çš„DCåç½®
- âœ… å¤„ç†ä¿¡å·æ¼‚ç§»ï¼ˆæ¸©åº¦ã€è€åŒ–ï¼‰
- âœ… æ— éœ€æ‰‹åŠ¨æ ¡å‡†

**ç¤ºä¾‹**:
```
åœºæ™¯1: ADCä¿¡å·åç½®åˆ°1800-2300
  â†’ V1: é›¶ç‚¹=2048ï¼Œå¯èƒ½æ£€æµ‹ä¸åˆ°é›¶äº¤å‰ï¼ˆå…¨éƒ¨>2048ï¼‰
  â†’ V2: è‡ªåŠ¨è®¡ç®—é›¶ç‚¹=2050ï¼Œæ­£å¸¸æ£€æµ‹

åœºæ™¯2: ADCä¿¡å·èŒƒå›´2500-3500
  â†’ V1: é›¶ç‚¹=2048ï¼Œæ°¸è¿œä¸ä¼šè§¦å‘é›¶äº¤å‰
  â†’ V2: è‡ªåŠ¨è®¡ç®—é›¶ç‚¹=3000ï¼Œæ­£å¸¸æ£€æµ‹
```

### 2. ADCæœ€å°/æœ€å¤§å€¼è·Ÿè¸ª

**è¾“å‡ºç«¯å£**:
```verilog
output reg [11:0] adc_min,  // ADCæœ€å°å€¼ï¼ˆè¿è¡Œæ—¶æŒç»­æ›´æ–°ï¼‰
output reg [11:0] adc_max   // ADCæœ€å¤§å€¼ï¼ˆè¿è¡Œæ—¶æŒç»­æ›´æ–°ï¼‰
```

**ç”¨é€”**:
- ğŸ“Š è¯„ä¼°ä¿¡å·æ‘†å¹…ï¼š`amplitude = (adc_max - adc_min) / 2`
- ğŸ” æ£€æµ‹ä¿¡å·åç½®ï¼š`bias = (adc_max + adc_min) / 2 - 2048`
- âš ï¸ è¯Šæ–­å¼‚å¸¸ï¼šå¦‚æœadc_min=adc_maxï¼Œè¯´æ˜ä¿¡å·æ— å˜åŒ–

### 3. é›¶äº¤å‰è®¡æ•°å™¨

**è¾“å‡ºç«¯å£**:
```verilog
output reg [15:0] zero_cross_count  // é›¶äº¤å‰äº‹ä»¶è®¡æ•°ï¼ˆ0-65535å¾ªç¯ï¼‰
```

**ç”¨é€”**:
- ğŸ“ˆ éªŒè¯é›¶äº¤å‰æ£€æµ‹æ˜¯å¦æ­£å¸¸å·¥ä½œ
- ğŸ• è®¡ç®—ä¿¡å·é¢‘ç‡ï¼š`freq = (count_delta * 60MHz) / time_delta`
- ğŸ› è°ƒè¯•ï¼šå¦‚æœcountä¸å¢é•¿ï¼Œè¯´æ˜é›¶äº¤å‰æ£€æµ‹å¤±è´¥

**ç¤ºä¾‹è®¡ç®—**:
```python
# å‡è®¾åœ¨1ç§’å†…ï¼Œzero_cross_countå¢åŠ äº†215000
freq = 215000 Hz = 215 kHz  âœ“ï¼ˆç¬¦åˆé¢„æœŸï¼‰

# å¦‚æœzero_cross_count = 0ï¼ˆä¸å˜ï¼‰
â†’ é›¶äº¤å‰æ£€æµ‹å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥ADCä¿¡å·æˆ–midpoint
```

### 4. åŠ¨æ€é›¶ç‚¹è¾“å‡º

**è¾“å‡ºç«¯å£**:
```verilog
output [11:0] adc_midpoint_out  // å½“å‰ä½¿ç”¨çš„åŠ¨æ€é›¶ç‚¹å€¼
```

**ç”¨é€”**:
- ğŸ” è§‚å¯Ÿæ ¡å‡†åçš„é›¶ç‚¹ä½ç½®
- ğŸ“Š ä¸2048å¯¹æ¯”ï¼Œå¾—å‡ºåç½®é‡
- ğŸ› éªŒè¯è‡ªé€‚åº”ç®—æ³•æ˜¯å¦å·¥ä½œ

---

## ğŸ”§ å¦‚ä½•ä½¿ç”¨ V2

### æ–¹æ¡ˆA: å®Œå…¨æ›¿æ¢ï¼ˆæ¨èï¼‰

**æ­¥éª¤**:
1. åœ¨`hs_dual_da_hdmi_top.v`ä¸­ä¿®æ”¹å®ä¾‹åŒ–

**ä¿®æ”¹å‰**:
```verilog
phase_detector u_phase_detector (
    .clk_60m        (usb_clk_60m           ),
    .rst_n          (rst_n                 ),
    .da_phase_sync  (phase_acc_60m_sync2   ),
    .bit_valid_sync (bit_seq_60m_sync2     ),
    .adc_data       (adc_capture_data      ),
    .adc_data_valid (adc_data_valid        ),
    .phase_diff     (phase_diff            ),
    .phase_valid    (phase_valid           ),
    .phase_diff_8bit(phase_diff_8bit       )
);
```

**ä¿®æ”¹å**:
```verilog
// Debug signals (add to wire declarations)
wire [11:0] adc_midpoint_debug;
wire [15:0] zero_cross_count_debug;
wire [11:0] adc_min_debug;
wire [11:0] adc_max_debug;

// Use V2 phase detector with debug outputs
phase_detector_v2 u_phase_detector (
    .clk_60m         (usb_clk_60m           ),
    .rst_n           (rst_n                 ),
    .da_phase_sync   (phase_acc_60m_sync2   ),
    .bit_valid_sync  (bit_seq_60m_sync2     ),
    .adc_data        (adc_capture_data      ),
    .adc_data_valid  (adc_data_valid        ),
    .phase_diff      (phase_diff            ),
    .phase_valid     (phase_valid           ),
    .phase_diff_8bit (phase_diff_8bit       ),
    // Debug outputs (new in V2)
    .adc_midpoint_out(adc_midpoint_debug    ),
    .zero_cross_count(zero_cross_count_debug),
    .adc_min         (adc_min_debug         ),
    .adc_max         (adc_max_debug         )
);
```

2. åœ¨Vivadoä¸­æ·»åŠ `rtl/phase_detector_v2.v`åˆ°å·¥ç¨‹
3. å¯é€‰ï¼šæ·»åŠ ILAç›‘æ§è°ƒè¯•ä¿¡å·

### æ–¹æ¡ˆB: ä¿ç•™V1ï¼Œä¸´æ—¶æµ‹è¯•V2

**æ­¥éª¤**:
1. é‡å‘½åæ¨¡å—å®ä¾‹ï¼š`u_phase_detector` â†’ `u_phase_detector_v1`
2. æ·»åŠ V2å®ä¾‹ï¼š`u_phase_detector_v2`
3. ä½¿ç”¨å‚æ•°æˆ–æ¡ä»¶ç¼–è¯‘åˆ‡æ¢

---

## ğŸ› è°ƒè¯•æµç¨‹ï¼ˆä½¿ç”¨V2ï¼‰

### Step 1: æ·»åŠ ILAç›‘æ§è°ƒè¯•ä¿¡å·

```tcl
# ILAé…ç½®
create_debug_core u_ila_phase ila
set_property C_DATA_DEPTH 4096 [get_debug_cores u_ila_phase]

# æ¢é’ˆ0: ADCæ•°æ®
create_debug_port u_ila_phase probe
set_property port_width 12 [get_debug_ports u_ila_phase/probe0]
connect_debug_port u_ila_phase/probe0 [get_nets {adc_capture_data[*]}]

# æ¢é’ˆ1: åŠ¨æ€é›¶ç‚¹
create_debug_port u_ila_phase probe
set_property port_width 12 [get_debug_ports u_ila_phase/probe1]
connect_debug_port u_ila_phase/probe1 [get_nets {adc_midpoint_debug[*]}]

# æ¢é’ˆ2: é›¶äº¤å‰è®¡æ•°å™¨
create_debug_port u_ila_phase probe
set_property port_width 16 [get_debug_ports u_ila_phase/probe2]
connect_debug_port u_ila_phase/probe2 [get_nets {zero_cross_count_debug[*]}]

# æ¢é’ˆ3: ADCæœ€å°å€¼
create_debug_port u_ila_phase probe
set_property port_width 12 [get_debug_ports u_ila_phase/probe3]
connect_debug_port u_ila_phase/probe3 [get_nets {adc_min_debug[*]}]

# æ¢é’ˆ4: ADCæœ€å¤§å€¼
create_debug_port u_ila_phase probe
set_property port_width 12 [get_debug_ports u_ila_phase/probe4]
connect_debug_port u_ila_phase/probe4 [get_nets {adc_max_debug[*]}]

# æ¢é’ˆ5: ç›¸ä½å·®
create_debug_port u_ila_phase probe
set_property port_width 9 [get_debug_ports u_ila_phase/probe5]
connect_debug_port u_ila_phase/probe5 [get_nets {phase_diff[*]}]

# æ¢é’ˆ6: DAç›¸ä½ï¼ˆåŒæ­¥åï¼‰
create_debug_port u_ila_phase probe
set_property port_width 16 [get_debug_ports u_ila_phase/probe6]
connect_debug_port u_ila_phase/probe6 [get_nets {phase_acc_60m_sync2[*]}]

# æ¢é’ˆ7: bit_seqï¼ˆåŒæ­¥åï¼‰
create_debug_port u_ila_phase probe
set_property port_width 1 [get_debug_ports u_ila_phase/probe7]
connect_debug_port u_ila_phase/probe7 [get_nets {bit_seq_60m_sync2}]
```

### Step 2: è¿è¡Œç¡¬ä»¶å¹¶æ•è·æ•°æ®

**è§‚å¯Ÿé¡¹**:
```
1. bit_seq_60m_sync2 = 1 (å¸¸1) âœ“
   â†’ ç¡®è®¤bitå¼ºåˆ¶ä¿®æ”¹ç”Ÿæ•ˆ

2. adc_midpoint_debug åœ¨å‰64ä¸ªé‡‡æ ·ç‚¹åç¨³å®š
   â†’ åŠ¨æ€æ ¡å‡†å®Œæˆ
   â†’ è®°å½•ç¨³å®šå€¼ï¼ˆå¦‚2150ï¼‰ï¼Œä¸2048å¯¹æ¯”å¾—å‡ºåç½®é‡

3. adc_min_debug, adc_max_debug
   â†’ ä¾‹å¦‚: min=1800, max=2500
   â†’ æ‘†å¹… = (2500-1800)/2 = 350 (çº¦0.86V)
   â†’ ä¸­å¿ƒ = (2500+1800)/2 = 2150 âœ“ï¼ˆä¸midpointä¸€è‡´ï¼‰

4. zero_cross_count_debug æŒç»­å¢é•¿
   â†’ ä¾‹å¦‚: æ¯1ç§’å¢åŠ 215000
   â†’ é¢‘ç‡ = 215 kHz âœ“ï¼ˆç¬¦åˆé¢„æœŸï¼‰
   â†’ å¦‚æœcount=0ï¼Œè¯´æ˜é›¶äº¤å‰æ£€æµ‹å¤±è´¥

5. phase_diff åœ¨åˆç†èŒƒå›´ï¼ˆ0-360ï¼‰
   â†’ å¦‚æœä»ç„¶åªæœ‰0-2ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥
```

### Step 3: åˆ†æç»“æœ

**åœºæ™¯1**: zero_cross_countæ­£å¸¸å¢é•¿ï¼Œphase_diffæ­£å¸¸
```
âœ… é—®é¢˜å·²è§£å†³ï¼
   â†’ åŠ¨æ€é›¶ç‚¹æ ¡å‡†æˆåŠŸé€‚åº”ADCåç½®
   â†’ ç›¸ä½æ£€æµ‹æ­£å¸¸å·¥ä½œ
```

**åœºæ™¯2**: zero_cross_count=0ï¼Œä¸å¢é•¿
```
âŒ é›¶äº¤å‰æ£€æµ‹å¤±è´¥
å¯èƒ½åŸå› :
  1. ADCä¿¡å·æ— å˜åŒ–ï¼ˆadc_min=adc_maxï¼‰
     â†’ æ£€æŸ¥ADCç¡¬ä»¶è¿æ¥
  2. ADCä¿¡å·åç½®è¿‡å¤§ï¼Œè¶…å‡ºåŠ¨æ€æ ¡å‡†èŒƒå›´
     â†’ æ£€æŸ¥adc_midpoint_debugå€¼æ˜¯å¦åˆç†
  3. bit_valid_sync=0
     â†’ æ£€æŸ¥bit_seqåŒæ­¥é“¾è·¯
```

**åœºæ™¯3**: zero_cross_countå¢é•¿ï¼Œä½†phase_diffå¼‚å¸¸ï¼ˆä»ç„¶0-2ï¼‰
```
âŒ ç›¸ä½è®¡ç®—æœ‰é—®é¢˜
å¯èƒ½åŸå› :
  1. phase_acc_60m_sync2åŒæ­¥å¤±è´¥
     â†’ æ£€æŸ¥ILAä¸­phase_acc_60m_sync2çš„å€¼
     â†’ åº”è¯¥åœ¨0-65535å¾ªç¯
  2. é›¶äº¤å‰è§¦å‘æ—¶æœºä¸å¯¹
     â†’ å¯èƒ½åœ¨phase_accæº¢å‡ºç¬é—´è§¦å‘
```

---

## ğŸ“Š é¢„æœŸæµ‹è¯•ç»“æœï¼ˆV2ï¼‰

### ILAæ³¢å½¢ç¤ºæ„

```
æ—¶é—´è½´ â†’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

bit_seq_60m_sync2:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (å¸¸1)

adc_capture_data:
     â•±â•²      â•±â•²      â•±â•²      â•±â•²      â•±â•²
   â•±    â•²  â•±    â•²  â•±    â•²  â•±    â•²  â•±    â•²
 â•±      â•²â•±      â•²â•±      â•²â•±      â•²â•±      â•²
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1800-2500èŒƒå›´ï¼ˆæ­£å¼¦æ³¢ï¼‰

adc_midpoint_debug:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  (2150, ç¨³å®š)

zero_cross_count_debug:
0 â†’ 1 â†’ 2 â†’ 3 â†’ 4 â†’ 5 â†’ ...  (æ¯ä¸ªæ­£å¼¦æ³¢å‘¨æœŸ+1)
     â†‘   â†‘   â†‘   â†‘   â†‘
   (æ¯4.65Î¼sè§¦å‘ä¸€æ¬¡ï¼Œ215kHz)

phase_diff:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
 120Â°   120Â°   120Â°   120Â°   120Â°  (ç¤ºä¾‹: å¦‚æœADCæ»å120Â°)
```

---

## âš™ï¸ å‚æ•°è°ƒæ•´

### æ ¡å‡†é‡‡æ ·ç‚¹æ•°

**é»˜è®¤**: 64ä¸ªé‡‡æ ·ç‚¹

**ä¿®æ”¹æ–¹æ³•**:
```verilog
parameter CALIBRATION_SAMPLES = 64;  // å¯æ”¹ä¸º32, 128, 256ç­‰ï¼ˆå¿…é¡»æ˜¯2çš„å¹‚ï¼‰
```

**å½±å“**:
- æ›´å°‘ï¼ˆ32ï¼‰ï¼šæ ¡å‡†æ›´å¿«ï¼Œä½†ç²¾åº¦ä½ï¼Œæ˜“å—å™ªå£°å½±å“
- æ›´å¤šï¼ˆ128ï¼‰ï¼šæ ¡å‡†æ›´ç²¾ç¡®ï¼Œä½†åˆå§‹åŒ–æ—¶é—´é•¿

**å»ºè®®**: ä¿æŒ64ï¼ˆåœ¨2MHzé‡‡æ ·ç‡ä¸‹ï¼Œä»…éœ€32Î¼sæ ¡å‡†æ—¶é—´ï¼‰

---

## ğŸ¯ æ€»ç»“

### V2 çš„ä¼˜åŠ¿

1. **è‡ªé€‚åº”èƒ½åŠ›å¼º**: è‡ªåŠ¨å¤„ç†ADCä¿¡å·åç½®å’Œæ¼‚ç§»
2. **è°ƒè¯•å‹å¥½**: ä¸°å¯Œçš„è°ƒè¯•è¾“å‡ºï¼Œæ˜“äºå®šä½é—®é¢˜
3. **ç”Ÿäº§å¯é **: æ— éœ€æ‰‹åŠ¨æ ¡å‡†ï¼Œé€‚åˆå®é™…åº”ç”¨

### æ¨èä½¿ç”¨åœºæ™¯

- âœ… **ä½¿ç”¨V2**: å®é™…ç¡¬ä»¶æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒã€ADCä¿¡å·åç½®æœªçŸ¥
- âš™ï¸ **ä½¿ç”¨V1**: ä»¿çœŸæµ‹è¯•ã€ç†æƒ³ä¿¡å·ï¼ˆæ— åç½®ï¼‰ã€èµ„æºå—é™

### ä¸‹ä¸€æ­¥

1. åœ¨`hs_dual_da_hdmi_top.v`ä¸­æ›¿æ¢ä¸ºphase_detector_v2
2. æ·»åŠ ILAç›‘æ§è°ƒè¯•ä¿¡å·
3. é‡æ–°ç»¼åˆã€å®ç°ã€ä¸‹è½½
4. è§‚å¯Ÿè°ƒè¯•è¾“å‡ºï¼ŒéªŒè¯ç›¸ä½æ£€æµ‹æ˜¯å¦æ­£å¸¸

---

**æ–‡ä»¶æ¸…å•**:
- `rtl/phase_detector_v2.v` - æ–°ç‰ˆç›¸ä½æ£€æµ‹å™¨ï¼ˆæœ¬æ–‡ä»¶ï¼‰
- `rtl/phase_detector.v` - åŸç‰ˆï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
- `ç›¸ä½æ£€æµ‹æµ‹è¯•åˆ†æ”¯è¯´æ˜.md` - æµ‹è¯•æ–¹æ¡ˆè¯´æ˜
- `ç›¸ä½æ£€æµ‹å™¨V2ä½¿ç”¨è¯´æ˜.md` - æœ¬æ–‡æ¡£

ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ‰

