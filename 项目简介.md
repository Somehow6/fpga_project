# 项目简介：压电振子通信系统

## 核心功能
基于FPGA的压电振子调制通信系统，实现图像数据通过机械振动传输和采集的完整闭环。

## 系统框架

```
┌──────────────────────────────────────────────────────────────────┐
│                    FPGA (Xilinx ZYNQ/Artix-7)                    │
│                                                                    │
│  ┌──────────────┐      ┌────────────────┐      ┌──────────────┐ │
│  │ 图像数据源   │      │   数据调制      │      │   DA输出     │ │
│  │              │      │                 │      │              │ │
│  │ MNIST ROM    │─────▶│ 位序列生成      │─────▶│ 正弦波调制   │─╋──▶ 压电振子
│  │ (28×28像素)  │      │ (200us/bit)     │      │ (10位DAC)    │ │   (机械振动)
│  │ 98000字节    │      │                 │      │ ~215kHz      │ │
│  └──────────────┘      └────────────────┘      └──────────────┘ │
│                                                                    │
│                                                                    │
│  ┌──────────────┐      ┌────────────────┐      ┌──────────────┐ │
│  │  USB输出     │      │   数据打包      │      │  ADC采集     │ │
│  │              │      │                 │      │              │ │
│  │ FT232H接口   │◀─────│ 12bit→2×8bit   │◀─────│ 12位ADC      │◀╋─── 压电振子
│  │ 60MHz        │      │ FIFO缓冲       │      │ 10MHz采样    │ │   (信号反馈)
│  │ 20MB/s       │      │ 异步时钟域     │      │              │ │
│  └──────────────┘      └────────────────┘      └──────────────┘ │
│         │                                                          │
│         ▼                                                          │
│    ┌─────────┐                                                    │
│    │  Python │  数据解析与显示                                    │
│    │   PC    │  plot_data.py                                     │
│    └─────────┘                                                    │
└──────────────────────────────────────────────────────────────────┘
```

## 技术参数

### 发射端（DA输出）
- **调制方式**：幅度键控（ASK / OOK）
- **载波频率**：~215 kHz（可调，默认addr_step=353）
- **位速率**：5000 bit/s（200us/bit）
- **DA分辨率**：10位（0-1023）
- **输出电压**：±5V
- **调制规则**：
  - bit=1：输出正弦波（幅度由ROM数据决定）
  - bit=0：输出0V（DAC=512）

### 接收端（ADC采集）
- **采样率**：10 MHz（20MHz时钟2分频）
- **ADC分辨率**：12位（0-4095）
- **数据格式**：2字节/样本
  - Byte1: adc_data[11:4] (高8位)
  - Byte2: {4'b0, adc_data[3:0]} (低4位)
- **传输速率**：20 MB/s（理论）

### 数据流
- **图像格式**：MNIST 28×28灰度图（784像素/图）
- **存储容量**：98000字节（约125张图像）
- **传输协议**：起始头(0xAA55) + 连续数据流
- **时钟域**：
  - DDS/ADC域：20 MHz
  - UART接收域：50 MHz
  - USB传输域：60 MHz

## 主要模块说明

### 1. 数据源模块
- **mnist_tx_controller.v**
  - 从MNIST ROM读取图像数据
  - 转换为位序列（200us/bit）
  - 同步UART输出（用于验证）
  - 支持图像间暂停功能

### 2. 调制输出模块
- **da_wave_send.v**
  - 生成可调频率正弦波（DDS原理）
  - 位序列调制：bit=1输出正弦波，bit=0输出0V
  - 频率控制：通过addr_step调节（610Hz分辨率）
- **rom_1024x10b**（IP核）
  - 存储1024点正弦波表
  - 10位数据输出

### 3. 信号采集模块
- **adc_capture.v**
  - 10MHz ADC时钟生成（20MHz÷2）
  - 12位ADC数据采集
  - 过载检测（OTR标志）
- **hs_adc_top.v**
  - ADC顶层封装

### 4. 数据打包模块
- **adc_to_usb.v**
  - 12位→2字节转换
  - 添加帧头标识（0xAA55）
  - 支持测试模式（计数器测试）
  - FIFO写接口（20MHz域）

### 5. USB传输模块
- **usb_tx.v**
  - FT232H同步FIFO模式
  - 4状态流水线（IDLE→SETUP→HOLD→WAIT）
  - 二级同步器（防止亚稳态）
  - 速率限制：20 MB/s
- **fifo_generator_1**（IP核）
  - 异步FIFO（20MHz写，60MHz读）
  - 深度：1024字节

### 6. 调试与测试
- **3种测试模式**（key[3]切换）：
  - Mode 0：USB测试（计数器直接输出）
  - Mode 1：ADC测试（测试模式数据通过FIFO）
  - Mode 2：正常模式（真实ADC数据）
- **ILA调试接口**
  - 监控USB状态机
  - 查看数据传输过程
  - 时序验证
- **LED指示**
  - LED[0]：按键按下指示
  - LED[1]：传输忙指示
  - LED[3]：ILA保持信号

### 7. 显示与控制
- **seg_led.v**
  - 6位七段数码管显示
  - 显示格式：[测试模式][频率步进值]
- **按键功能**：
  - key[0]：减小频率
  - key[1]：增大频率
  - key[2]：启动数据传输
  - key[3]：切换测试模式

## 时钟架构

```
          50MHz                      clk_wiz_0 (PLL)
        sys_clk   ─────────┬─────────────────────────────┐
                           │                              │
                           ├──▶ clk_200m (200MHz)  DDR3   │
                           ├──▶ clk_50m  (50MHz)   UART/I2C
                           ├──▶ clk_20m  (20MHz)   DDS/ADC
                           ├──▶ pixel_clk (65MHz)  HDMI像素
                           └──▶ pixel_clk_5x (325MHz) HDMI串行化
                           
        60MHz (外部)
        usb_clk_60m ────────▶ USB传输模块
```

## 扩展功能（已实现框架）

### OV5640摄像头模块（当前已注释）
- **分辨率**：支持多种分辨率（RGB565格式）
- **接口**：I2C配置 + 并行数据
- **DDR3缓存**：帧缓冲
- **HDMI输出**：1024×768@60Hz实时显示

### 未来可实现功能
1. 用真实摄像头替代MNIST ROM
2. 实时图像边缘提取→转换为1D序列
3. 多通道压电阵列（相控阵）
4. 解调器实现（从ADC数据恢复位序列）
5. 误码率测试与纠错编码

## 应用场景
- 水下/非金属材料通信
- 机械结构健康监测
- 超声数据传输实验
- 声波图像传输研究
- FPGA信号处理教学

## 文件结构
```
33_hs_dual_da/
├── rtl/                          # RTL源代码
│   ├── hs_dual_da_hdmi_top.v    # 顶层模块
│   ├── hs_dual_da.v             # DDS+MNIST子系统
│   ├── mnist_tx_controller.v    # 位序列发生器
│   ├── da_wave_send.v           # DA调制输出
│   ├── adc_capture.v            # ADC采集
│   ├── adc_to_usb.v             # 数据打包
│   ├── usb_tx.v                 # USB传输
│   ├── uart_rx.v / uart_tx.v    # UART通信
│   ├── seg_led.v                # 数码管显示
│   └── ov5640_*.v               # 摄像头模块（可选）
├── prj/                          # Vivado工程
├── plot_data.py                  # PC端数据接收与显示
├── ILA_配置步骤.md               # ILA调试指南
└── ILA修复步骤.md                # ILA问题解决方案
```

## 开发环境
- **FPGA开发工具**：Xilinx Vivado 2018.3+
- **目标芯片**：Xilinx Zynq/Artix-7系列
- **编程语言**：Verilog HDL
- **PC端工具**：Python 3.x + PyUSB + Matplotlib
- **调试工具**：ILA（Integrated Logic Analyzer）

## 关键技术点
1. **DDS算法**：数控振荡器实现可调频率正弦波
2. **ASK调制**：幅度键控调制实现数字信号传输
3. **异步FIFO**：跨时钟域数据传输
4. **USB高速传输**：FT232H同步FIFO模式
5. **亚稳态防护**：二级同步器设计
6. **ILA在线调试**：实时信号监控

---
**项目状态**：✅ 核心功能已实现并验证  
**最后更新**：2025-11-04



