# 相位检测测试分支 - 快速开始指南 🚀

**日期**: 2025/11/08  
**目标**: 强制DA输出连续正弦波，测试相位检测器功能

---

## ✅ 已完成的修改

### 1️⃣ 强制bit_sequence=1（连续正弦波输出）

**文件**: `rtl/hs_dual_da.v`（第91行）

```verilog
// 修改前:
// assign  bit_sequence = bit_sequence_internal;

// 修改后:
assign  bit_sequence = 1'b1;  // 强制常1，连续正弦波
```

**效果**: DA输出连续215kHz正弦波（不再ASK调制）

---

### 2️⃣ 新增改进版相位检测器（可选）

**文件**: `rtl/phase_detector_v2.v`（新文件）

**新功能**:
- ✅ 动态零点校准（自适应ADC偏置）
- ✅ ADC最小/最大值跟踪
- ✅ 零交叉计数器
- ✅ 调试输出端口

**是否使用**: 可选（如果当前问题未解决，再使用V2）

---

## 🔧 快速测试步骤

### Step 1: 重新综合（必需）

```bash
# 在Vivado中
1. 打开项目: prj/hs_dual_da.xpr
2. Run Synthesis
3. Run Implementation
4. Generate Bitstream
5. Program Device
```

### Step 2: 硬件验证（示波器）

**检查DA输出**:
```
预期: 连续正弦波，频率215kHz（或当前addr_step对应频率）
     不再有ASK调制的幅度变化（全是正弦波）

示波器设置:
- 探头: DA输出（da_data → 实际电压）
- 时基: 5μs/div
- 幅度: 2V/div
- 触发: 上升沿
```

### Step 3: 观察相位差输出

**方法A: 通过USB读取相位数据**

如果USB传输选择了相位模式（key[1]切换），应该能读取到phase_diff_8bit数据。

**方法B: 通过数码管显示**

如果key[1]切换到显示相位模式，数码管应显示0-360度的相位差。

**预期结果**:
```
✅ 正常: 相位差在0-360度范围变化（取决于实际相位关系）
❌ 异常: 相位差仍然只在0-2徘徊
```

---

## 🐛 如果问题仍未解决

### 问题A: 相位差仍然0-2

**可能原因**:
1. ADC信号偏置问题（不在2048附近）
2. 零交叉检测失败
3. phase_acc同步失败

**解决方案**: 使用V2相位检测器

**操作步骤**:
1. 参考`相位检测器V2使用说明.md`
2. 在`hs_dual_da_hdmi_top.v`中替换为phase_detector_v2
3. 添加ILA监控调试信号
4. 重新综合测试

### 问题B: DA输出仍然是ASK调制

**检查**:
```verilog
// 确认 rtl/hs_dual_da.v 第91行修改是否生效
assign  bit_sequence = 1'b1;  // 应该是这个
```

**验证**: 查看示波器，DA输出应该是连续正弦波

### 问题C: ADC信号异常

**检查ADC数据**:

通过USB读取Mode 2（正常ADC）数据，分析：
```python
import numpy as np

# 读取ADC数据（12-bit）
adc_data = [...]  # 从USB读取

print(f"最小值: {np.min(adc_data)}")
print(f"最大值: {np.max(adc_data)}")
print(f"平均值: {np.mean(adc_data)}")
print(f"标准差: {np.std(adc_data)}")

# 预期:
# 最小值: 1500-2500 范围（视信号幅度）
# 最大值: 1500-2500 范围
# 平均值: 应接近2048（如果无偏置）
# 标准差: >100（有信号变化）
```

**如果平均值!=2048**: 说明有DC偏置，需要使用V2相位检测器

---

## 📊 预期测试结果对比

### 修改前（ASK调制）
```
DA输出:
     ╱╲          ╱╲          ╱╲
   ╱    ╲      ╱    ╲      ╱    ╲
 ╱      ╲    ╱      ╲    ╱      ╲
──────────0V─────────0V─────────  (bit=0时输出0V)
bit=1       bit=0       bit=1

相位检测: 只在bit=1时工作，bit=0时停止
          → 采样点少，相位差不稳定
```

### 修改后（连续正弦波）
```
DA输出:
     ╱╲      ╱╲      ╱╲      ╱╲      ╱╲
   ╱    ╲  ╱    ╲  ╱    ╲  ╱    ╲  ╱    ╲
 ╱      ╲╱      ╲╱      ╲╱      ╲╱      ╲
────────────────────────────────────────  (连续正弦波)

相位检测: 持续工作，每个周期更新相位差
          → 采样点多，相位差稳定
```

---

## 🎯 成功标志

### ✅ 测试成功的指标

1. **DA输出**: 连续正弦波（示波器观察）
2. **相位差范围**: 0-360度（不再是0-2）
3. **相位差稳定**: 连续读取，数值稳定（±5度内）
4. **零交叉检测**: 正常触发（如果使用V2，zero_cross_count持续增长）

### ❌ 仍需调试的情况

1. 相位差仍然0-2 → 使用V2相位检测器
2. DA输出不是连续正弦波 → 检查代码修改
3. 相位差跳变大 → 检查ADC信号质量/噪声

---

## 🔄 回滚方法

如果需要恢复原功能（ASK调制）:

```verilog
// 在 rtl/hs_dual_da.v 第91行
// 改回原来的代码:
assign  bit_sequence = bit_sequence_internal;  // 恢复ASK调制
```

---

## 📁 相关文档

1. **相位检测测试分支说明.md** - 详细问题分析和调试步骤
2. **相位检测器V2使用说明.md** - V2功能说明和使用方法
3. **本文档** - 快速开始指南

---

## 💡 下一步计划

### 当前目标: 验证相位检测基本功能

1. ✅ DA输出连续正弦波
2. ⏳ 相位检测正常工作（0-360度范围）

### 后续目标: 相位锁定控制

1. 根据相位差调整DA频率（PLL功能）
2. 实现相位同步（phase_diff趋向0）
3. 测试不同频率下的相位跟踪

### 最终目标: 闭环通信系统

1. DA → 压电振子 → ADC（物理链路）
2. 相位检测 → 频率调整 → 相位锁定
3. 数据调制 → 传输 → 解调

---

**当前状态**: ✅ 代码修改完成，等待硬件测试验证

**预计耗时**: 10-30分钟（重新综合 + 硬件测试）

祝测试顺利！有问题随时反馈。🎉

