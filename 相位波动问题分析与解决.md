# 相位波动问题分析与解决方案

## 📊 问题描述

从测试日志 `phase_debug_log.txt` 中观察到：
- **相位数据在0-360°之间疯狂跳变**，没有稳定趋势
- 相位标准差高达 **103.97°**，几乎均匀分布
- 每帧相位变化无规律，例如：
  - 帧0: 211.69° → 帧1: 284.75° → 帧2: 357.36° → 帧3: **74.46°** (突然跳回)

## 🔍 根本原因分析

### 1. DDS输出频率过高

从代码 `rtl/da_wave_send.v` 发现：

```verilog
reg    [15:0]   addr_step_reg = 16'd705;  // 默认值
// 频率计算: f_out = (20MHz × 705) / 65536 = 215.1 kHz
```

**关键数据对比：**

| 参数 | 值 | 说明 |
|------|-----|------|
| **DDS输出频率** | ~215 kHz | 太高！ |
| **USB数据包发送频率** | 1 kHz (1ms/帧) | Debug packet发送速率 |
| **1ms内信号周期数** | **215个完整周期** | 相位转了215圈 |
| **相位旋转总角度** | **77,400°** (215×360°) | 等效于随机采样 |
| **零交叉计数增量** | 每帧约220次 | 与理论值一致 |

### 2. 严重的采样率不匹配（奈奎斯特定理违反）

**奈奎斯特采样定理**：采样频率必须至少是信号最高频率的2倍。

当前情况：
- 信号频率: 215 kHz
- 采样频率: 1 kHz
- **采样率比: 1:215** ← 严重违反奈奎斯特定理！

**类比说明：**
这就像用1帧/秒的慢动作相机去拍摄一个每秒旋转215圈的高速风扇，你只能看到风扇叶片的随机位置，无法追踪真实的旋转速度。

### 3. 相位检测逻辑分析

从 `phase_detector_v2.v` 代码看：

```verilog
assign phase_diff_12bit = da_phase_sync[15:4];  // 直接提取DDS相位累加器的高12位
```

虽然相位检测器会在每个ADC零交叉时更新相位值，但：
- 在1ms内有 **215个零交叉**
- 相位检测更新了215次
- USB debug packet只发送最后一次的瞬时值
- 由于信号频率太高，每次采样的相位值都是随机的

### 4. 数据统计印证

从日志统计部分：

```
相位(Raw)  - 最小: 0, 最大: 4095, 平均: 2051.02, 标准差: 1182.61
相位(度)   - 最小: 0.00°, 最大: 360.00°, 平均: 180.31°, 标准差: 103.97°
动态零点   - 最小: 1865, 最大: 2097, 平均: 2045.36, 标准差: 5.69
ADC最小值  - 最小: 1752, 最大: 2041, 平均: 1752.01, 标准差: 1.38
ADC最大值  - 最小: 1752, 最大: 2347, 平均: 2346.99, 标准差: 2.83
零交叉计数 - 最小: 0, 最大: 65535, 平均: 32750.77, 标准差: 18904.97
```

**关键观察：**
- ✅ 动态零点稳定（标准差5.69）- 动态校准工作正常
- ✅ ADC最小/最大值稳定 - 信号幅度稳定
- ✅ 零交叉计数持续递增 - 零交叉检测正常
- ❌ 相位均值180°，标准差104° - 接近均匀分布，说明采样随机

## ✅ 解决方案

### 方案：降低DDS输出频率

#### 推荐频率范围: 1-10 kHz

| addr_step | 输出频率 | 1ms内周期数 | 适用性 | 推荐度 |
|-----------|---------|------------|--------|--------|
| **705** (当前) | 215 kHz | 215 | ❌ 太高，无法追踪 | - |
| **33** | 10 kHz | 10 | ✅ 可用 | ⭐⭐ |
| **16** | 5 kHz | 5 | ✅ 较好 | ⭐⭐⭐⭐ |
| **10** | 3 kHz | 3 | ✅ 良好 | ⭐⭐⭐⭐⭐ |
| **7** | 2 kHz | 2 | ✅ 很好 | ⭐⭐⭐⭐⭐ |
| **3** | 1 kHz | 1 | ✅ 理想 | ⭐⭐⭐⭐⭐ |

**建议：`addr_step` = 7-16，对应频率 2-5 kHz**

原因：
1. **1ms内只有2-5个周期**，相位变化可以被清晰追踪
2. 满足奈奎斯特采样定理（采样率是信号频率的100-500倍）
3. 仍然足够快以测试压电振子的传输特性
4. 相位数据将呈现线性或稳定的趋势，而非随机分布

#### 实现方法

**方法A: 通过按键实时调整（推荐，无需重新综合）**

1. 上电后，数码管前4位会显示当前 `addr_step` 值（默认已改为16）
2. 使用 Key[0] 调整：
   - **短按**：减小频率（addr_step - 1）
   - **长按**：增加频率（addr_step + 1）
3. 建议值：**7-16**（对应2-5 kHz）
4. 切换到数据模式2（Debug Packet模式），重新采集数据
5. 观察相位数据是否呈现稳定趋势

**方法B: 代码已修改（需重新综合）**

已修改 `rtl/da_wave_send.v` 的默认值：

```verilog
// 修改前:
reg    [15:0]   addr_step_reg = 16'd705; // 215 kHz

// 修改后:
reg    [15:0]   addr_step_reg = 16'd16;  // ~5 kHz (推荐用于相位检测)
```

**重新综合并下载bitstream后，默认频率将为 ~5 kHz。**

## 📈 预期效果

降低频率后，相位数据应该呈现以下特征：

### 1. 如果DA和ADC采样率完全同步
- **相位应该稳定在一个固定值** (例如: 45° ± 5°)
- 标准差应小于10°
- 反映压电振子的固有相位延迟

### 2. 如果DA和ADC采样率有微小差异
- **相位应该呈现线性漂移** (例如: 0° → 360° 线性增长或减小)
- 漂移速率恒定
- 反映DA和ADC时钟的频率差

### 3. 典型数据示例（期望）

```
帧 #0:    相位: 45.2°
帧 #1:    相位: 45.8°
帧 #2:    相位: 46.3°
帧 #3:    相位: 46.9°
...
或者：
帧 #0:    相位: 10.0°
帧 #1:    相位: 15.2°
帧 #2:    相位: 20.4°
帧 #3:    相位: 25.6°
```

**关键指标：**
- 相位变化应该平滑、连续
- 标准差应该显著降低（< 20°）
- 相邻帧之间的相位差应该一致

## 🔧 后续测试步骤

1. ✅ 修改 `addr_step` 到 7-16 范围（已通过代码修改）
2. 🔄 重新综合并下载bitstream（或通过按键调整）
3. 🔄 重新采集相位debug数据
4. 🔄 分析新的相位曲线，确认：
   - 相位是否稳定或线性变化？
   - 标准差是否降低到< 20°？
   - 零交叉计数是否合理（每帧增量2-10）？
5. 🔄 如果仍有问题，可能需要检查：
   - `phase_detector_v2` 的相位计算逻辑
   - ADC和DA之间的时钟同步
   - 压电振子的传输特性

## 📝 相关文件修改记录

### 修改文件: `rtl/da_wave_send.v`

**修改1: 更新默认频率（第55行）**
```verilog
// 修改前:
reg    [15:0]   addr_step_reg = 16'd705; // 215 kHz

// 修改后:
reg    [15:0]   addr_step_reg = 16'd16;  // ~5 kHz
```

**修改2: 更新复位默认值（第104行）**
```verilog
// 修改前:
addr_step_reg <= 16'd705;

// 修改后:
addr_step_reg <= 16'd16;
```

**修改3: 添加频率计算注释（第52行）**
```verilog
// When addr_step=16: f_out = (20,000,000 × 16) / 65536 = 4.88 kHz (RECOMMENDED for phase detection)
```

## 📚 理论背景

### 奈奎斯特采样定理

> 为了无失真地恢复原始信号，采样频率必须大于等于信号最高频率的2倍。

$$f_{sampling} \geq 2 \times f_{signal}$$

**当前情况：**
- 原始配置: $f_{sampling}$ = 1 kHz, $f_{signal}$ = 215 kHz
- 违反程度: **215倍**
- 结果: 混叠（Aliasing），导致相位随机化

**修正后：**
- 新配置: $f_{sampling}$ = 1 kHz, $f_{signal}$ = 5 kHz
- 采样率比: **1:5** (每个周期采样200次)
- 结果: 可以清晰追踪相位变化

### DDS相位累加器原理

DDS（Direct Digital Synthesis）使用相位累加器生成周期信号：

```
phase_accumulator = phase_accumulator + addr_step
output = sin(phase_accumulator)
```

- `addr_step` 越大，相位累加越快，输出频率越高
- 输出频率: $f_{out} = \frac{f_{clk} \times addr\_step}{2^{N}}$
  - $f_{clk}$ = 20 MHz (系统时钟)
  - $N$ = 16 (相位累加器位宽)

## 🎯 总结

**问题根源：** DDS输出频率（215 kHz）远高于USB采样频率（1 kHz），导致严重的采样不足，相位数据变为随机分布。

**解决方法：** 将DDS频率降低到 2-5 kHz（`addr_step` = 7-16），使1ms采样窗口内只有2-5个信号周期，从而可以清晰追踪相位变化。

**期望结果：** 相位数据呈现稳定值或线性漂移，标准差降低到< 20°，能够正确反映压电振子的传输特性。

---

**日期：** 2025-11-08  
**分析人：** AI Assistant  
**文件版本：** v1.0

