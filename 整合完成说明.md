# DDS + HDMI 项目整合完成说明

## 整合概述

成功将两个独立项目整合到一个统一的FPGA设计中：
1. **DDS项目** (`33_hs_dual_da`): DA波形输出 + MNIST位序列 + UART通信
2. **HDMI项目** (`40_ov5640_hdmi`): OV5640摄像头 + DDR3缓存 + HDMI显示

## 完成的工作

### ✅ 阶段1：RTL文件复制
已将以下14个HDMI相关模块复制到DDS项目的rtl目录：
- asyn_rst_syn.v
- cmos_capture_data.v
- ddr3_fifo_ctrl.v
- ddr3_rw.v
- ddr3_top.v
- dvi_encoder.v
- dvi_transmitter_top.v
- hdmi_top.v
- i2c_dri.v
- i2c_ov5640_rgb565_cfg.v
- ov5640_dri.v
- ov5640_hdmi.v
- serializer_10_to_1.v
- video_driver.v

### ✅ 阶段2：修改hs_dual_da.v
**文件**: `rtl/hs_dual_da.v`

**主要修改**:
1. 删除内部PLL实例化（原clk_wiz_0）
2. 添加外部时钟输入端口：
   - `input clk_50m` - 50MHz用于UART RX
   - `input locked` - PLL锁定信号
3. 将sys_clk改为直接使用20MHz输入
4. UART RX模块改用clk_50m时钟

### ✅ 阶段3：修改ov5640_hdmi.v
**文件**: `rtl/ov5640_hdmi.v`

**主要修改**:
1. 删除内部PLL实例化（原clk_wiz_0）
2. 添加外部时钟输入端口：
   - `input clk_200m` - DDR3参考时钟
   - `input clk_50m` - 摄像头配置时钟
   - `input pixel_clk` - HDMI像素时钟
   - `input pixel_clk_5x` - HDMI串行化时钟
   - `input locked` - PLL锁定信号
3. 删除sys_clk输入端口（不再需要）

### ✅ 阶段4：创建统一顶层模块
**文件**: `rtl/hs_dual_da_hdmi_top.v`

**功能**:
- 例化统一PLL（clk_wiz_unified）生成5个时钟
- 例化hs_dual_da子模块（DDS功能）
- 例化ov5640_hdmi子模块（摄像头+HDMI功能）
- 统一管理复位信号
- 合并所有外部接口

**端口总数**: 
- 输入: 28个信号/总线
- 输出: 57个信号/总线
- 双向: 3个信号/总线

### ✅ 阶段5：合并约束文件
**文件**: `prj/hs_dual_da.srcs/constrs_1/new/hs_dual_da.xdc`

**追加内容**:
1. HDMI接口引脚（TMDS差分信号）
2. 摄像头接口引脚（数据、控制、I2C）
3. 摄像头时钟约束（40ns周期，25MHz）

**注意**: DDR3引脚约束由MIG IP核自动生成

### ✅ 阶段6：PLL配置指南
**文件**: `PLL_Configuration_Guide.md`

详细说明如何在Vivado中配置统一PLL，包括：
- 5个输出时钟的具体参数（与原HDMI项目兼容）
  - 20MHz (DDS), 50MHz (UART/I2C), 200MHz (DDR3)
  - 65MHz (HDMI 1024×768), 325MHz (HDMI串行化)
- 频率精度要求
- 常见问题解决方案
- 验证步骤

## 项目结构

```
33_hs_dual_da/
├── rtl/
│   ├── hs_dual_da_hdmi_top.v    [新建] 统一顶层模块
│   ├── hs_dual_da.v              [已修改] DDS子模块
│   ├── ov5640_hdmi.v             [已修改] HDMI子模块
│   ├── da_wave_send.v            [保持不变]
│   ├── mnist_tx_controller.v     [保持不变]
│   ├── uart_tx.v / uart_rx.v     [保持不变]
│   ├── seg_led.v / binary2bcd.v  [保持不变]
│   ├── [14个HDMI模块]            [新复制]
├── prj/
│   └── hs_dual_da.srcs/constrs_1/new/
│       └── hs_dual_da.xdc        [已更新] 合并后的约束
├── PLL_Configuration_Guide.md    [新建] PLL配置指南
└── 整合完成说明.md               [新建] 本文档
```

## 下一步操作（需要在Vivado中手动完成）

### 1. 配置统一PLL IP核 ⚠️ **必需**
参考 `PLL_Configuration_Guide.md` 文档：
```
IP Name: clk_wiz_0
Input: 50MHz
Outputs: 
  - clk_out1: 200MHz (DDR3)
  - clk_out2: 50MHz (UART/I2C)
  - clk_out3: 20MHz (DDS)
  - clk_out4: 65MHz (HDMI pixel, 1024×768 @ 60Hz)
  - clk_out5: 325MHz (HDMI serialization)
```

### 2. 添加/配置IP核 ⚠️ **必需**

需要从HDMI项目复制或重新生成以下IP核：

#### a. MIG DDR3控制器
- **来源**: `40_ov5640_hdmi/prj/ov5640_hdmi.srcs/sources_1/ip/mig_7series_0`
- **配置文件**: `mig_a.prj`
- **操作**: 
  1. 在Vivado中打开IP Catalog
  2. 搜索"Memory Interface Generator"
  3. 导入原项目的配置文件，或按原项目参数重新配置

#### b. 读FIFO（rd_fifo）
- **来源**: `40_ov5640_hdmi/prj/ov5640_hdmi.srcs/sources_1/ip/rd_fifo`
- **类型**: FIFO Generator
- **参数**: 
  - 数据宽度: 128位输入 / 16位输出
  - 深度: 512
  - 独立读写时钟

#### c. 写FIFO（wr_fifo）
- **来源**: `40_ov5640_hdmi/prj/ov5640_hdmi.srcs/sources_1/ip/wr_fifo`
- **类型**: FIFO Generator
- **参数**:
  - 数据宽度: 16位输入 / 128位输出
  - 深度: 512
  - 独立读写时钟

#### d. DDS项目原有IP核
- `clk_wiz_0` - **需要重新配置**（从1个输出改为5个输出）
- `rom_1024x10b` - 保留（正弦波ROM）
- `blk_mem_gen_0` - 保留（MNIST图像ROM）

### 3. 项目设置

在Vivado项目中：

#### a. 添加源文件
```tcl
# 添加新的顶层模块和HDMI相关RTL
add_files -norecurse {
    rtl/hs_dual_da_hdmi_top.v
    rtl/asyn_rst_syn.v
    rtl/cmos_capture_data.v
    rtl/ddr3_fifo_ctrl.v
    rtl/ddr3_rw.v
    rtl/ddr3_top.v
    rtl/dvi_encoder.v
    rtl/dvi_transmitter_top.v
    rtl/hdmi_top.v
    rtl/i2c_dri.v
    rtl/i2c_ov5640_rgb565_cfg.v
    rtl/ov5640_dri.v
    rtl/ov5640_hdmi.v
    rtl/serializer_10_to_1.v
    rtl/video_driver.v
}
```

#### b. 设置顶层模块
```tcl
set_property top hs_dual_da_hdmi_top [current_fileset]
```

#### c. 更新约束文件
确保约束文件包含：
- 已更新的 `hs_dual_da.xdc`
- MIG生成的 `mig_7series_0.xdc`

### 4. 综合和实现

#### 综合前检查清单
- [ ] 所有RTL文件已添加
- [ ] 顶层模块设置正确
- [ ] PLL IP核已生成
- [ ] DDR3 MIG IP核已配置
- [ ] FIFO IP核已添加
- [ ] 约束文件已更新

#### 运行流程
```
1. Run Synthesis
2. 检查综合报告（资源占用、时钟）
3. Run Implementation
4. 检查时序报告（确保无时序违规）
5. Generate Bitstream
6. Program Device
```

## 资源占用估计

基于两个项目的资源占用：

| 资源类型 | DDS项目 | HDMI项目 | 整合估计 | 备注 |
|---------|---------|----------|----------|------|
| LUT | ~5% | ~40% | ~45% | 基本相加 |
| FF | ~3% | ~30% | ~33% | 基本相加 |
| BRAM | ~10% | ~25% | ~35% | ROM + FIFO |
| DSP | 0 | 0 | 0 | 未使用 |
| MMCM | 1 | 1 | 1 | 合并为统一PLL |
| IO | 35 | 65 | 88 | 引脚总数 |

**推荐芯片**: XC7A100T或更大（当前可能是XC7A35T或XC7A50T，需要确认）

## 功能测试计划

### 测试1：DDS功能
- [ ] 上电后LED指示正常
- [ ] 数码管显示ADDR_STEP值
- [ ] 按键调整频率（key[0]/key[1]）
- [ ] DA输出波形正确（示波器观察）
- [ ] UART TX发送MNIST数据（key[2]触发）

### 测试2：摄像头功能
- [ ] 摄像头模块上电
- [ ] I2C配置成功（cam_scl信号活动）
- [ ] 摄像头输出图像数据（cam_pclk有效）

### 测试3：DDR3功能
- [ ] DDR3初始化成功（init_calib_complete信号）
- [ ] 写入摄像头数据
- [ ] 读取数据用于显示

### 测试4：HDMI显示
- [ ] HDMI输出时钟正常
- [ ] 显示器检测到信号
- [ ] 显示摄像头实时图像
- [ ] 图像无撕裂、帧率稳定

### 测试5：整体联调
- [ ] DDS和HDMI同时工作
- [ ] 无相互干扰
- [ ] 所有功能正常

## 可能遇到的问题和解决方案

### 问题1：资源不足
**现象**: 综合或实现失败，提示资源超限

**解决方案**:
1. 检查FPGA芯片型号（至少需要XC7A100T）
2. 优化设计：
   - 减少MNIST ROM大小
   - 降低HDMI分辨率到640x480
   - 减少FIFO深度

### 问题2：时序违规
**现象**: 时序报告显示WNS < 0

**解决方案**:
1. 降低pixel_clk频率（当前1024×768可改为640×480）
2. 添加流水线寄存器
3. 优化约束文件
4. 使用更快的速度等级芯片

### 问题3：PLL锁定失败
**现象**: locked信号不为高，系统无法正常工作

**解决方案**:
1. 检查输入时钟是否正确（应为50MHz）
2. 检查PLL配置参数
3. 检查VCO频率范围
4. 确认复位信号正常

### 问题4：DDR3初始化失败
**现象**: init_calib_complete一直为低

**解决方案**:
1. 检查MIG配置是否正确
2. 检查DDR3引脚约束
3. 确认200MHz参考时钟正常
4. 检查PCB布线和信号完整性

### 问题5：HDMI无输出
**现象**: 显示器无信号

**解决方案**:
1. 检查pixel_clk和pixel_clk_5x频率
2. 确认TMDS信号完整性
3. 检查tmds_oen使能信号
4. 尝试降低分辨率

## 技术要点总结

### 时钟域管理
项目涉及6个时钟域：
1. clk_20m (20MHz) - DDS
2. clk_50m (50MHz) - UART/Camera config
3. clk_200m (200MHz) - DDR3
4. pixel_clk (74.25MHz) - HDMI
5. pixel_clk_5x (371.25MHz) - HDMI serialization
6. cam_pclk (异步输入) - 摄像头数据

**CDC处理**:
- cam_pclk → DDR3: 通过wr_fifo异步FIFO
- DDR3 → pixel_clk: 通过rd_fifo异步FIFO

### 复位策略
- 全局复位：`rst_n = sys_rst_n & locked`
- 确保PLL锁定后再释放复位
- 各子系统使用统一的复位信号

### 引脚规划
- 总计88个引脚（35 DDS + 53 HDMI/Camera/DDR3）
- 注意高速信号：TMDS差分对、DDR3信号
- 摄像头数据引脚需要IOB约束

## 联系和支持

如有问题，请参考：
1. `PLL_Configuration_Guide.md` - PLL配置详细说明
2. 原项目文档
3. Xilinx文档：
   - UG472: Clocking Resources
   - UG586: Constraining Designs
   - PG058: MIG User Guide

---

**整合完成时间**: 2024年  
**版本**: v1.0  
**状态**: ✅ RTL代码整合完成，⚠️ 等待Vivado项目配置

